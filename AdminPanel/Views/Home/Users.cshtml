

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-users text-primary mr-2"></i>Пользователи
        </h1>
        <div class="d-flex align-items-center">
            <button type="button" class="btn btn-outline-primary btn-sm mr-2" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
            <div class="input-group input-group-sm mr-2" style="width: 250px;">
                <input type="text" class="form-control" placeholder="Поиск пользователей..." id="searchInput">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addUserModal">
                <i class="fas fa-plus"></i> Добавить
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Статистика -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Всего пользователей
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Активных
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeUsers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Онлайн сейчас
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="onlineUsers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Новых сегодня
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="newToday">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица пользователей -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Список пользователей</h6>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                        id="filterDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-filter"></i> Фильтр
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="filterDropdown">
                    <a class="dropdown-item filter-option" href="#" data-filter="all">Все</a>
                    <a class="dropdown-item filter-option" href="#" data-filter="active">Активные</a>
                    <a class="dropdown-item filter-option" href="#" data-filter="online">Онлайн</a>
                    <a class="dropdown-item filter-option" href="#" data-filter="banned">Заблокированные</a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="usersTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Имя</th>
                            <th>VK ID</th>
                            <th>Username</th>
                            <th>Сообщений</th>
                            <th>Статус</th>
                            <th>Дата регистрации</th>
                            <th>Последняя активность</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info" id="dataTable_info" role="status" aria-live="polite">
                    Показано <span id="showingCount">0</span> из <span id="totalCount">0</span> записей
                </div>
                <div class="dataTables_paginate paging_simple_numbers" id="dataTable_paginate">
                    <ul class="pagination" id="pagination">
                        <!-- Пагинация будет добавлена через JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления пользователя -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Добавить пользователя</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="vkUserId">VK User ID</label>
                        <input type="number" class="form-control" id="vkUserId" name="vkUserId" required>
                        <small class="form-text text-muted">Числовой идентификатор пользователя VK</small>
                    </div>
                    <div class="form-group">
                        <label for="firstName">Имя</label>
                        <input type="text" class="form-control" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Фамилия</label>
                        <input type="text" class="form-control" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" class="form-control" id="username" name="username">
                        <small class="form-text text-muted">Например: id123456 или username</small>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="phone">Телефон</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования пользователя -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Редактировать пользователя</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="id">
                    <div class="form-group">
                        <label for="editVkUserId">VK User ID</label>
                        <input type="number" class="form-control" id="editVkUserId" name="vkUserId" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editFirstName">Имя</label>
                        <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Фамилия</label>
                        <input type="text" class="form-control" id="editLastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email">
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Телефон</label>
                        <input type="tel" class="form-control" id="editPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="editLocation">Местоположение</label>
                        <input type="text" class="form-control" id="editLocation" name="location">
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="editIsActive" name="isActive">
                            <label class="form-check-label" for="editIsActive">Активный</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="editIsBanned" name="isBanned">
                            <label class="form-check-label" for="editIsBanned">Заблокирован</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="updateUserBtn">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно детальной информации -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">Информация о пользователе</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <div class="user-avatar bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 100px; height: 100px; font-size: 40px;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h5 class="mt-3" id="detailsFullName"></h5>
                            <p class="text-muted mb-1" id="detailsUsername"></p>
                            <span class="badge badge-success" id="detailsStatus"></span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Основная информация</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><strong>VK ID:</strong> <span id="detailsVkId"></span></li>
                                    <li class="mb-2"><strong>Email:</strong> <span id="detailsEmail"></span></li>
                                    <li class="mb-2"><strong>Телефон:</strong> <span id="detailsPhone"></span></li>
                                    <li class="mb-2"><strong>Местоположение:</strong> <span id="detailsLocation"></span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Статистика</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><strong>Сообщений:</strong> <span id="detailsMessageCount"></span></li>
                                    <li class="mb-2"><strong>Регистрация:</strong> <span id="detailsRegDate"></span></li>
                                    <li class="mb-2"><strong>Последняя активность:</strong> <span id="detailsLastActivity"></span></li>
                                    <li class="mb-2"><strong>Сессий:</strong> <span id="detailsSessions"></span></li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary">История сообщений</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="messageHistoryTable">
                                        <thead>
                                            <tr>
                                                <th>Дата</th>
                                                <th>Сообщение</th>
                                                <th>Тип</th>
                                            </tr>
                                        </thead>
                                        <tbody id="messageHistoryBody">
                                            <!-- История сообщений будет загружена через JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let pageSize = 10;
        let currentFilter = 'all';
        let currentSearch = '';

        $(document).ready(function() {
            loadStatistics();
            loadUsers();

            // Обработчики событий
            $('#refreshBtn').click(function() {
                loadStatistics();
                loadUsers();
            });

            $('#searchBtn').click(function() {
                currentSearch = $('#searchInput').val();
                currentPage = 1;
                loadUsers();
            });

            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    currentSearch = $(this).val();
                    currentPage = 1;
                    loadUsers();
                }
            });

            $('.filter-option').click(function(e) {
                e.preventDefault();
                currentFilter = $(this).data('filter');
                currentPage = 1;
                loadUsers();
            });

            $('#saveUserBtn').click(function() {
                saveUser();
            });

            $('#updateUserBtn').click(function() {
                updateUser();
            });

            // Обновление статистики каждые 30 секунд
            setInterval(loadStatistics, 30000);
        });

        function loadStatistics() {
            $.ajax({
                url: '/api/users/stats',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const data = response.data;
                        $('#totalUsers').text(data.totalUsers);
                        $('#activeUsers').text(data.activeUsers);
                        $('#onlineUsers').text(data.onlineUsers);
                        $('#newToday').text(data.newToday);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки статистики:', error);
                    showToast('error', 'Ошибка', 'Не удалось загрузить статистику');
                }
            });
        }

        function loadUsers() {
            const params = {
                page: currentPage,
                pageSize: pageSize,
                filter: currentFilter,
                search: currentSearch
            };

            $.ajax({
                url: '/api/users',
                method: 'GET',
                data: params,
                success: function(response) {
                    if (response.success) {
                        renderUsers(response.data.users);
                        renderPagination(response.data.totalPages);
                        updateCounters(response.data);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки пользователей:', error);
                    showToast('error', 'Ошибка', 'Не удалось загрузить пользователей');
                }
            });
        }

        function renderUsers(users) {
            const tbody = $('#usersTableBody');
            tbody.empty();

            if (users.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                            <p class="text-muted">Пользователи не найдены</p>
                        </td>
                    </tr>
                `);
                return;
            }

            users.forEach(function(user) {
                const statusBadge = getUserStatusBadge(user);
                const registrationDate = new Date(user.registrationDate).toLocaleDateString();
                const lastActivity = user.lastActivity ? new Date(user.lastActivity).toLocaleString() : 'Никогда';

                const row = `
                    <tr data-user-id="${user.id}">
                        <td>${user.id}</td>
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>
                            <a href="https://vk.com/${user.username || 'id' + user.vkUserId}" 
                               target="_blank" class="text-primary">
                                ${user.vkUserId}
                            </a>
                        </td>
                        <td>${user.username || '-'}</td>
                        <td>${user.messageCount}</td>
                        <td>${statusBadge}</td>
                        <td>${registrationDate}</td>
                        <td>${lastActivity}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-info btn-sm view-user" 
                                        data-user-id="${user.id}" title="Просмотр">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-primary btn-sm edit-user" 
                                        data-user-id="${user.id}" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.isBanned ? 
                                    `<button type="button" class="btn btn-success btn-sm unban-user" 
                                            data-user-id="${user.id}" title="Разблокировать">
                                        <i class="fas fa-unlock"></i>
                                    </button>` : 
                                    `<button type="button" class="btn btn-warning btn-sm ban-user" 
                                            data-user-id="${user.id}" title="Заблокировать">
                                        <i class="fas fa-ban"></i>
                                    </button>`
                                }
                                <button type="button" class="btn btn-danger btn-sm delete-user" 
                                        data-user-id="${user.id}" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // Назначаем обработчики событий для кнопок
            $('.view-user').click(function() {
                const userId = $(this).data('user-id');
                viewUser(userId);
            });

            $('.edit-user').click(function() {
                const userId = $(this).data('user-id');
                editUser(userId);
            });

            $('.ban-user').click(function() {
                const userId = $(this).data('user-id');
                banUser(userId);
            });

            $('.unban-user').click(function() {
                const userId = $(this).data('user-id');
                unbanUser(userId);
            });

            $('.delete-user').click(function() {
                const userId = $(this).data('user-id');
                deleteUser(userId);
            });
        }

        function renderPagination(totalPages) {
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            // Кнопка "Назад"
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `);

            // Номера страниц
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }

            // Кнопка "Вперед"
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `);

            // Обработчики кликов на пагинации
            $('.page-link[data-page]').click(function(e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (page > 0 && page <= totalPages) {
                    currentPage = page;
                    loadUsers();
                }
            });
        }

        function updateCounters(data) {
            $('#showingCount').text(data.users.length);
            $('#totalCount').text(data.totalCount);
        }

        function getUserStatusBadge(user) {
            if (user.isBanned) {
                return '<span class="badge badge-danger">Заблокирован</span>';
            } else if (user.isOnline) {
                return '<span class="badge badge-success">Онлайн</span>';
            } else if (user.isActive) {
                return '<span class="badge badge-primary">Активен</span>';
            } else {
                return '<span class="badge badge-secondary">Неактивен</span>';
            }
        }

        function viewUser(userId) {
            $.ajax({
                url: `/api/users/${userId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const user = response.data;
                        populateUserDetails(user);
                        loadUserMessageHistory(userId);
                        $('#userDetailsModal').modal('show');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки данных пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось загрузить данные пользователя');
                }
            });
        }

        function populateUserDetails(user) {
            $('#detailsFullName').text(`${user.firstName} ${user.lastName}`);
            $('#detailsUsername').text(user.username ? ${user.username} : '');
            $('#detailsVkId').text(user.vkUserId);
            $('#detailsEmail').text(user.email || '-');
            $('#detailsPhone').text(user.phone || '-');
            $('#detailsLocation').text(user.location || '-');
            $('#detailsMessageCount').text(user.messageCount);
            $('#detailsRegDate').text(new Date(user.registrationDate).toLocaleDateString());
            $('#detailsLastActivity').text(user.lastActivity ? 
                new Date(user.lastActivity).toLocaleString() : 'Никогда');
            $('#detailsSessions').text(user.sessionCount || 0);
            
            // Статус
            let statusText = '';
            let statusClass = '';
            if (user.isBanned) {
                statusText = 'Заблокирован';
                statusClass = 'badge-danger';
            } else if (user.isOnline) {
                statusText = 'Онлайн';
                statusClass = 'badge-success';
            } else if (user.isActive) {
                statusText = 'Активен';
                statusClass = 'badge-primary';
            } else {
                statusText = 'Неактивен';
                statusClass = 'badge-secondary';
            }
            $('#detailsStatus').text(statusText).removeClass().addClass(`badge ${statusClass}`);
        }

        function loadUserMessageHistory(userId) {
            $.ajax({
                url: `/api/users/${userId}/messages`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        renderMessageHistory(response.data);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки истории сообщений:', error);
                    $('#messageHistoryBody').html(`
                        <tr>
                            <td colspan="3" class="text-center text-muted py-2">
                                Не удалось загрузить историю сообщений
                            </td>
                        </tr>
                    `);
                }
            });
        }

        function renderMessageHistory(messages) {
            const tbody = $('#messageHistoryBody');
            tbody.empty();

            if (messages.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            <i class="fas fa-comment-slash fa-2x mb-2"></i>
                            <p>Нет сообщений</p>
                        </td>
                    </tr>
                `);
                return;
            }

            messages.forEach(function(message) {
                const date = new Date(message.timestamp).toLocaleString();
                const typeBadge = message.type === 'incoming' ? 
                    '<span class="badge badge-info">Входящее</span>' : 
                    '<span class="badge badge-success">Исходящее</span>';

                const row = `
                    <tr>
                        <td>${date}</td>
                        <td>${message.text || '-'}</td>
                        <td>${typeBadge}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function editUser(userId) {
            $.ajax({
                url: `/api/users/${userId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const user = response.data;
                        $('#editUserId').val(user.id);
                        $('#editVkUserId').val(user.vkUserId);
                        $('#editFirstName').val(user.firstName);
                        $('#editLastName').val(user.lastName);
                        $('#editUsername').val(user.username || '');
                        $('#editEmail').val(user.email || '');
                        $('#editPhone').val(user.phone || '');
                        $('#editLocation').val(user.location || '');
                        $('#editIsActive').prop('checked', user.isActive);
                        $('#editIsBanned').prop('checked', user.isBanned);
                        $('#editUserModal').modal('show');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки данных пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось загрузить данные пользователя');
                }
            });
        }

        function updateUser() {
            const formData = {
                id: $('#editUserId').val(),
                firstName: $('#editFirstName').val(),
                lastName: $('#editLastName').val(),
                username: $('#editUsername').val(),
                email: $('#editEmail').val(),
                phone: $('#editPhone').val(),
                location: $('#editLocation').val(),
                isActive: $('#editIsActive').prop('checked'),
                isBanned: $('#editIsBanned').prop('checked')
            };

            $.ajax({
                url: `/api/users/${formData.id}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#editUserModal').modal('hide');
                        showToast('success', 'Успех', 'Пользователь обновлен');
                        loadUsers();
                    } else {
                        showToast('error', 'Ошибка', response.message || 'Не удалось обновить пользователя');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка обновления пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось обновить пользователя');
                }
            });
        }

        function saveUser() {
            const formData = {
                vkUserId: parseInt($('#vkUserId').val()),
                firstName: $('#firstName').val(),
                lastName: $('#lastName').val(),
                username: $('#username').val(),
                email: $('#email').val(),
                phone: $('#phone').val()
            };

            $.ajax({
                url: '/api/users',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#addUserModal').modal('hide');
                        $('#addUserForm')[0].reset();
                        showToast('success', 'Успех', 'Пользователь добавлен');
                        loadStatistics();
                        loadUsers();
                    } else {
                        showToast('error', 'Ошибка', response.message || 'Не удалось добавить пользователя');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка добавления пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось добавить пользователя');
                }
            });
        }

        function banUser(userId) {
            if (!confirm('Вы уверены, что хотите заблокировать этого пользователя?')) {
                return;
            }

            const reason = prompt('Укажите причину блокировки:', 'Нарушение правил');

            $.ajax({
                url: `/api/users/${userId}/ban`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ reason: reason }),
                success: function(response) {
                    if (response.success) {
                        showToast('success', 'Успех', 'Пользователь заблокирован');
                        loadUsers();
                    } else {
                        showToast('error', 'Ошибка', response.message || 'Не удалось заблокировать пользователя');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка блокировки пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось заблокировать пользователя');
                }
            });
        }

        function unbanUser(userId) {
            if (!confirm('Вы уверены, что хотите разблокировать этого пользователя?')) {
                return;
            }

            $.ajax({
                url: `/api/users/${userId}/unban`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showToast('success', 'Успех', 'Пользователь разблокирован');
                        loadUsers();
                    } else {
                        showToast('error', 'Ошибка', response.message || 'Не удалось разблокировать пользователя');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка разблокировки пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось разблокировать пользователя');
                }
            });
        }

        function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить.')) {
                return;
            }

            $.ajax({
                url: `/api/users/${userId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showToast('success', 'Успех', 'Пользователь удален');
                        loadStatistics();
                        loadUsers();
                    } else {
                        showToast('error', 'Ошибка', response.message || 'Не удалось удалить пользователя');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка удаления пользователя:', error);
                    showToast('error', 'Ошибка', 'Не удалось удалить пользователя');
                }
            });
        }

        function showToast(type, title, message) {
            // Простая реализация уведомлений
            const toast = $(`
                <div class="toast bg-${type === 'success' ? 'success' : 'danger'} text-white" 
                     role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="toast-header bg-${type === 'success' ? 'success' : 'danger'} text-white">
                        <strong class="mr-auto">${title}</strong>
                        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `);

            $('body').append(toast);
            toast.toast({ delay: 3000 });
            toast.toast('show');

            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    </script>
}
