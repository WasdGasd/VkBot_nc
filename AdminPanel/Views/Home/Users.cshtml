
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Пользователи</h1>

            <!-- Кнопки управления -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" onclick="loadUsers()">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                        <button class="btn btn-success" onclick="createTestUser()">
                            <i class="fas fa-plus"></i> Добавить тестового
                        </button>
                        <button class="btn btn-warning" onclick="createBulkUsers(10)">
                            <i class="fas fa-users"></i> +10 пользователей
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Поиск по имени, фамилии, username...">
                        <button class="btn btn-outline-primary" onclick="searchUsers()">
                            <i class="fas fa-search"></i> Поиск
                        </button>
                    </div>
                </div>
            </div>

            <!-- Статистика в реальном времени -->
            <div class="row mb-4" id="statsContainer">
                <div class="col-md-3 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Всего пользователей</h5>
                            <h2 id="totalUsers" class="mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Активных</h5>
                            <h2 id="activeUsers" class="mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Онлайн</h5>
                            <h2 id="onlineUsers" class="mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Новых сегодня</h5>
                            <h2 id="newToday" class="mb-0">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Таблица пользователей -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Список пользователей</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> Фильтр
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="setFilter('all')">Все пользователи</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('active')">Только активные</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('online')">Только онлайн</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setFilter('banned')">Забаненные</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Индикатор загрузки -->
                    <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2 text-muted">Загрузка пользователей...</p>
                    </div>

                    <!-- Таблица -->
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="usersTable" style="display: none;">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">ID</th>
                                    <th>Имя пользователя</th>
                                    <th>VK ID</th>
                                    <th>Статус</th>
                                    <th>Сообщения</th>
                                    <th>Дата регистрации</th>
                                    <th>Последняя активность</th>
                                    <th width="150">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Данные будут загружены через JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Сообщение об отсутствии данных -->
                    <div id="noDataMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Пользователи не найдены</h5>
                        <p class="text-muted">Нажмите "Добавить тестового" чтобы создать пользователей</p>
                    </div>

                    <!-- Пагинация -->
                    <div id="paginationContainer" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                        <div class="text-muted">
                            Показано <span id="currentCount">0</span> из <span id="totalCount">0</span> пользователей
                        </div>
                        <nav>
                            <ul class="pagination mb-0" id="pagination">
                                <!-- Пагинация будет сгенерирована через JS -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра пользователя -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Конфигурация
        let currentPage = 1;
        const pageSize = 20;
        let currentSearch = '';
        let currentFilter = 'all';
        let totalPages = 1;

        // Утилиты для работы с DOM
        function showElement(id) {
            document.getElementById(id).style.display = '';
        }

        function hideElement(id) {
            document.getElementById(id).style.display = 'none';
        }

        function setElementText(id, text) {
            document.getElementById(id).textContent = text;
        }

        // Форматирование даты
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Форматирование статуса
        function getStatusBadge(user) {
            if (user.isBanned) {
                return '<span class="badge bg-danger">Забанен</span>';
            }
            if (!user.isActive) {
                return '<span class="badge bg-secondary">Неактивен</span>';
            }
            if (user.isOnline) {
                return '<span class="badge bg-success">Онлайн</span>';
            }
            return '<span class="badge bg-primary">Активен</span>';
        }

        // Основная функция загрузки пользователей
        async function loadUsers(page = 1) {
            try {
                // Показываем индикатор загрузки
                hideElement('usersTable');
                hideElement('noDataMessage');
                hideElement('paginationContainer');
                showElement('loadingIndicator');

                // Формируем URL
                const params = new URLSearchParams({
                    page: page,
                    pageSize: pageSize,
                    search: currentSearch,
                    status: currentFilter,
                    sort: 'newest'
                });

                // Делаем запрос
                const response = await fetch(`/api/v1/users?${params}`);
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    displayUsers(result.data);
                    updateStats(result.data);
                } else {
                    showError('Ошибка загрузки данных');
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                showError('Не удалось загрузить пользователей: ' + error.message);
            } finally {
                hideElement('loadingIndicator');
            }
        }

        // Отображение пользователей в таблице
        function displayUsers(data) {
            const users = data.users;
            const tbody = document.getElementById('usersTableBody');
            
            // Очищаем таблицу
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                // Показываем сообщение об отсутствии данных
                hideElement('usersTable');
                hideElement('paginationContainer');
                showElement('noDataMessage');
                return;
            }

            // Заполняем таблицу
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${user.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar me-3 bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 40px; height: 40px;">
                                <span class="text-white fw-bold">
                                    ${user.firstName.charAt(0)}${user.lastName.charAt(0)}
                                </span>
                            </div>
                            <div>
                                <div class="fw-bold">${user.firstName} ${user.lastName}</div>
                                <div class="text-muted small">
                                     ${user.username || 'без username'}
                                    ${user.email ? `• ${user.email}` : ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <code class="bg-light p-1 rounded">${user.vkUserId}</code>
                    </td>
                    <td>
                        ${getStatusBadge(user)}
                        <div class="small text-muted mt-1">${user.status}</div>
                    </td>
                    <td>
                        <span class="badge bg-info rounded-pill">${user.messageCount}</span>
                    </td>
                    <td>
                        <div class="small">${formatDate(user.registrationDate)}</div>
                    </td>
                    <td>
                        <div class="small">${formatDate(user.lastActivity)}</div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="viewUser(${user.id})" title="Просмотр">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editUser(${user.id})" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            // Показываем таблицу и пагинацию
            showElement('usersTable');
            showElement('paginationContainer');
            
            // Обновляем пагинацию
            updatePagination(data.page, data.totalPages);
            
            // Обновляем счетчики
            setElementText('currentCount', users.length);
            setElementText('totalCount', data.totalCount);
        }

        // Обновление статистики
        function updateStats(data) {
            setElementText('totalUsers', data.totalCount);
            setElementText('activeUsers', data.activeCount || 0);
            setElementText('onlineUsers', data.onlineCount || 0);
            setElementText('newToday', data.newTodayCount || 0);
        }

        // Обновление пагинации
        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Кнопка "Назад"
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" ${currentPage > 1 ? `onclick="changePage(${currentPage - 1})"` : ''}>
                    <i class="fas fa-chevron-left"></i>
                </a>
            `;
            pagination.appendChild(prevLi);

            // Страницы
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                `;
                pagination.appendChild(pageLi);
            }

            // Кнопка "Вперед"
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" ${currentPage < totalPages ? `onclick="changePage(${currentPage + 1})"` : ''}>
                    <i class="fas fa-chevron-right"></i>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Смена страницы
        function changePage(page) {
            currentPage = page;
            loadUsers(page);
        }

        // Поиск пользователей
        function searchUsers() {
            currentSearch = document.getElementById('searchInput').value;
            currentPage = 1;
            loadUsers(currentPage);
        }

        // Установка фильтра
        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 1;
            loadUsers(currentPage);
        }

        // Просмотр пользователя
        async function viewUser(userId) {
            try {
                const response = await fetch(`/api/v1/users/${userId}`);
                if (!response.ok) throw new Error('Пользователь не найден');
                
                const result = await response.json();
                
                if (result.success) {
                    const user = result.data.user;
                    const content = document.getElementById('userDetailsContent');
                    
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-4 text-center mb-4">
                                <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                                     style="width: 100px; height: 100px;">
                                    <span class="text-white fs-2 fw-bold">
                                        ${user.firstName.charAt(0)}${user.lastName.charAt(0)}
                                    </span>
                                </div>
                                <h4>${user.firstName} ${user.lastName}</h4>
                                <p class="text-muted">${user.username || 'без username'}</p>
                                <div class="mt-3">
                                    ${getStatusBadge(user)}
                                </div>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">ID:</label>
                                        <div class="fw-bold">${user.id}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">VK ID:</label>
                                        <div><code>${user.vkUserId}</code></div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Email:</label>
                                        <div>${user.email || '<span class="text-muted">Не указан</span>'}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Телефон:</label>
                                        <div>${user.phone || '<span class="text-muted">Не указан</span>'}</div>
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label text-muted">Местоположение:</label>
                                        <div>${user.location || '<span class="text-muted">Не указано</span>'}</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-muted">Сообщений:</label>
                                        <div><span class="badge bg-info">${user.messageCount}</span></div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-muted">Дата регистрации:</label>
                                        <div>${formatDate(user.registrationDate)}</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label text-muted">Последняя активность:</label>
                                        <div>${formatDate(user.lastActivity)}</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Активен:</label>
                                        <div>${user.isActive ? '✅ Да' : '❌ Нет'}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Онлайн:</label>
                                        <div>${user.isOnline ? '✅ Да' : '❌ Нет'}</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Забанен:</label>
                                        <div>${user.isBanned ? '❌ Да' : '✅ Нет'}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted">Тип:</label>
                                        <div><span class="badge bg-secondary">${user.status}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                    modal.show();
                }
            } catch (error) {
                alert('Ошибка при загрузке данных пользователя: ' + error.message);
            }
        }

        // Создание тестового пользователя
        async function createTestUser() {
            try {
                const response = await fetch('/api/v1/users/test', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Тестовый пользователь создан!');
                    loadUsers(currentPage);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Создание нескольких тестовых пользователей
        async function createBulkUsers(count) {
            try {
                const response = await fetch(`/api/v1/users/bulk-test?count=${count}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Создано ${result.data.count} тестовых пользователей!`);
                    loadUsers(currentPage);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Редактирование пользователя (заглушка)
        function editUser(userId) {
            alert(`Редактирование пользователя ID: ${userId}\n(функция в разработке)`);
        }

        // Удаление пользователя
        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Пользователь удален');
                    loadUsers(currentPage);
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Показать ошибку
        function showError(message) {
            hideElement('usersTable');
            hideElement('paginationContainer');
            hideElement('noDataMessage');
            
            const container = document.getElementById('usersTableBody').parentElement;
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadUsers()">
                        Попробовать снова
                    </button>
                </div>
            `;
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем пользователей
            loadUsers();
            
            // Настройка поиска по Enter
            document.getElementById('searchInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    searchUsers();
                }
            });
            
            // Автообновление каждые 30 секунд
            setInterval(() => {
                loadUsers(currentPage);
            }, 30000);
        });
    </script>

    <style>
        .avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar-lg {
            width: 100px;
            height: 100px;
            font-size: 2rem;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .badge {
            font-size: 0.85em;
            padding: 0.35em 0.65em;
        }
    </style>
}