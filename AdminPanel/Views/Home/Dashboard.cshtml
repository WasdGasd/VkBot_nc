@{
    ViewData["Title"] = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</h2>
    <button onclick="loadAllRealStats()" class="btn btn-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ -->
        <div class="stat-card bg-primary">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5>üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    <h3 id="totalUsers">0</h3>
                </div>
                <span class="fs-1">üë•</span>
            </div>
        </div>

        <div class="stat-card bg-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5>üü¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    <h3 id="activeUsers">0</h3>
                </div>
                <span class="fs-1">üü¢</span>
            </div>
        </div>

        <div class="stat-card bg-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</h5>
                    <h3 id="messagesToday">0</h3>
                </div>
                <span class="fs-1">üí¨</span>
            </div>
        </div>

        <div class="stat-card bg-warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5>üü° –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</h5>
                    <h3 id="onlineUsers">0</h3>
                </div>
                <span class="fs-1">üü°</span>
            </div>
        </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê - –¢–û–õ–¨–ö–û –≠–ö–°–ü–û–†–¢ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">–í—ã –º–æ–∂–µ—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö</p>
                <button class="btn btn-success w-100 mb-2" onclick="exportData('excel')">
                    üìà –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
                <button class="btn btn-success w-100 mb-2" onclick="exportData('csv')">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
                <button class="btn btn-success w-100" onclick="exportData('json')">
                    üìã –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —Å–µ–≥–æ–¥–Ω—è</h5>
                <button onclick="loadRealCommandsStats()" class="btn btn-sm btn-outline-primary">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-7">
                        <canvas id="commandsChart" width="400" height="400"></canvas>
                    </div>
                    <div class="col-md-5">
                        <div id="commandsList" class="mt-3">
                            <p class="text-muted">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let commandsChart = null;
        let weeklyChart = null;
        let lastUpdateTime = null;

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –†–ï–ê–õ–¨–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================

        async function loadRealStats() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –†–ï–ê–õ–¨–ù–£–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');

                // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–ê–® –†–ï–ê–õ–¨–ù–´–ô –ö–û–ù–¢–†–û–õ–õ–ï–†
                const response = await fetch('/api/BotStats/dashboard');
                const result = await response.json();

                if (result.success && result.source === 'REAL_DATA_FROM_DATABASE') {
                    const stats = result.data;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
                    document.getElementById('messagesToday').textContent = stats.messagesToday || 0;
                    document.getElementById('onlineUsers').textContent = stats.onlineUsers || 0;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    lastUpdateTime = new Date().toLocaleTimeString();
                    console.log('‚úÖ –†–ï–ê–õ–¨–ù–ê–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', stats);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showMessage('üìä –ó–∞–≥—Ä—É–∂–µ–Ω—ã –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î', 'success');
                } else {
                    console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', result.message);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ');
                    setZeroStats(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏ –≤–º–µ—Å—Ç–æ –¥–µ–º–æ
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                setZeroStats(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏ –≤–º–µ—Å—Ç–æ –¥–µ–º–æ
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏ –≤–º–µ—Å—Ç–æ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
        function setZeroStats() {
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('activeUsers').textContent = '0';
            document.getElementById('messagesToday').textContent = '0';
            document.getElementById('onlineUsers').textContent = '0';
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –†–ï–ê–õ–¨–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ö–û–ú–ê–ù–î ====================

        async function loadRealCommandsStats() {
            try {
                document.getElementById('commandsList').innerHTML =
                    '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö...</div>';

                // –ò–°–ü–û–õ–¨–ó–£–ï–ú –†–ï–ê–õ–¨–ù–´–ô –ö–û–ù–¢–†–û–õ–õ–ï–†
                const response = await fetch('/api/BotStats/commands');
                const result = await response.json();

                if (result.success) {
                    if (result.source === 'REAL_DATA_FROM_COMMANDUSAGE' && Object.keys(result.data).length > 0) {
                        updateRealCommandsList(result.data, result.totalUsage);

                        await loadChartLibrary();
                        createRealCommandsChart(result.data);

                        showMessage('üìã –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –†–ï–ê–õ–¨–ù–ê–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥', 'success');
                    } else {
                        // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CommandUsage
                        document.getElementById('commandsList').innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥</strong>
                                <p class="mb-0 small">–¢–∞–±–ª–∏—Ü–∞ CommandUsage –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                            </div>
                        `;

                        // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
                        await loadChartLibrary();
                        createEmptyCommandsChart();
                    }
                } else {
                    throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –†–ï–ê–õ–¨–ù–û–ô —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–º–∞–Ω–¥:', error);
                document.getElementById('commandsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–º–∞–Ω–¥</strong>
                        <p class="mb-0 small">${error.message}</p>
                    </div>
                `;

                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                await loadChartLibrary();
                createEmptyCommandsChart();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏
        function updateRealCommandsList(commandsData, totalUsage) {
            const commandsList = document.getElementById('commandsList');

            if (!commandsData || Object.keys(commandsData).length === 0) {
                commandsList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                    </div>
                `;
                return;
            }

            let html = '<h6>üèÜ –¢–æ–ø –∫–æ–º–∞–Ω–¥ (–†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ):</h6>';
            html += '<div class="list-group" style="max-height: 300px; overflow-y: auto;">';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
            const sortedEntries = Object.entries(commandsData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // –¢–æ–ø-8

            sortedEntries.forEach(([command, count], index) => {
                const percentage = totalUsage > 0 ? Math.round((count / totalUsage) * 100) : 0;
                const badgeClass = index < 3 ? 'bg-primary' : 'bg-secondary';

                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge ${badgeClass} me-2">${index + 1}</span>
                            <code title="${escapeHtml(command)}">${truncateText(command, 20)}</code>
                        </div>
                        <div>
                            <span class="badge bg-info me-2">${count}</span>
                            <span class="text-muted small">${percentage}%</span>
                        </div>
                    </div>`;
            });

            html += `</div>`;
            html += `<div class="mt-2 text-muted small">
                        –í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: <strong>${totalUsage}</strong><br>
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥: <strong>${Object.keys(commandsData).length}</strong>
                     </div>`;

            commandsList.innerHTML = html;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏
        function createRealCommandsChart(commandsData) {
            const ctx = document.getElementById('commandsChart');
            if (!ctx) return;

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π —á–∞—Ä—Ç
            if (commandsChart) {
                commandsChart.destroy();
            }

            const labels = Object.keys(commandsData);
            const data = Object.values(commandsData);

            // –¶–≤–µ—Ç–∞
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
            ];

            commandsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '–†–ï–ê–õ–¨–ù–û–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥',
                            font: { size: 14 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // –ü—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        function createEmptyCommandsChart() {
            const ctx = document.getElementById('commandsChart');
            if (!ctx) return;

            if (commandsChart) {
                commandsChart.destroy();
            }

            commandsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥',
                            font: { size: 14, color: '#6c757d' }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –†–ï–ê–õ–¨–ù–û–ô –ù–ï–î–ï–õ–¨–ù–û–ô –ê–ö–¢–ò–í–ù–û–°–¢–ò ====================

        async function loadRealWeeklyActivity() {
            try {
                // –ò–°–ü–û–õ–¨–ó–£–ï–ú –†–ï–ê–õ–¨–ù–´–ô –ö–û–ù–¢–†–û–õ–õ–ï–†
                const response = await fetch('/api/BotStats/weekly-activity');
                const result = await response.json();

                if (result.success && result.source === 'REAL_DATA_FROM_MESSAGES') {
                    await loadChartLibrary();
                    createRealWeeklyChart(result.data);

                    showMessage('üìà –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –†–ï–ê–õ–¨–ù–ê–Ø –Ω–µ–¥–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', 'success');
                } else {
                    throw new Error(result.message || '–ù–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –†–ï–ê–õ–¨–ù–û–ô –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);

                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                await loadChartLibrary();
                createEmptyWeeklyChart();
            }
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Å –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏
        function createRealWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;

            if (weeklyChart) {
                weeklyChart.destroy();
            }

            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels || ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                    datasets: [
                        {
                            label: '–°–æ–æ–±—â–µ–Ω–∏–π (–†–ï–ê–õ–¨–ù–û)',
                            data: data.messagesData || [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Ü–µ–Ω–∫–∞)',
                            data: data.usersData || [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '–†–ï–ê–õ–¨–ù–ê–Ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–†–ï–ê–õ–¨–ù–û–ï)'
                            }
                        }
                    }
                }
            });
        }

        // –ü—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        function createEmptyWeeklyChart() {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;

            if (weeklyChart) {
                weeklyChart.destroy();
            }

            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                    datasets: [
                        {
                            label: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(200, 200, 200, 0.5)',
                            borderColor: 'rgba(200, 200, 200, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
                            font: { size: 14, color: '#6c757d' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                            }
                        }
                    }
                }
            });
        }

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–°–ï–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================

        async function loadAllRealStats() {
            console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –í–°–ï–ô –†–ï–ê–õ–¨–ù–û–ô —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoadingIndicator();

            try {
                await Promise.all([
                    loadRealStats(),
                    loadRealCommandsStats(),
                    loadRealWeeklyActivity()
                ]);

                console.log('‚úÖ –í—Å—è –†–ï–ê–õ–¨–ù–ê–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                hideLoadingIndicator();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showNotification('‚úÖ –í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                hideLoadingIndicator();
                showNotification('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ß–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

        function showRealDataNotification(message) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –≤—Å–ø–ª—ã–≤–∞—à–∫—É
            console.log('üí° ' + message);
        }

        function showError(message) {
            console.error('‚ùå ' + message);
        }

        function showLoadingIndicator() {
            const btn = document.querySelector('button[onclick="loadAllStats()"]');
            if (btn) {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
                btn.disabled = true;
            }
        }

        function hideLoadingIndicator() {
            const btn = document.querySelector('button[onclick="loadAllStats()"]');
            if (btn) {
                btn.innerHTML = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ';
                btn.disabled = false;
            }
        }

        function showNotification(type, title, message) {
            // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            console.log(`${icon} ${title}: ${message}`);
        }

        function loadChartLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Dashboard —Å –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ
            loadAllRealStats();

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                loadRealStats();
                console.log('üîÑ –†–ï–ê–õ–¨–ù–ê–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', new Date().toLocaleTimeString());
            }, 60000);
        });

                  // ==================== –†–ê–ë–û–ß–ò–ô –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• ====================

        function exportData(format) {
            console.log(`üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ ${format.toUpperCase()}`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showMessage(`–ù–∞—á–∏–Ω–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç –≤ ${format.toUpperCase()}...`, 'info');

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const buttons = document.querySelectorAll('.btn-success');
            buttons.forEach(btn => btn.disabled = true);

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportData = {
                date: new Date().toISOString(),
                dashboard: {
                    totalUsers: parseInt(document.getElementById('totalUsers').textContent) || 0,
                    activeUsers: parseInt(document.getElementById('activeUsers').textContent) || 0,
                    messagesToday: parseInt(document.getElementById('messagesToday').textContent) || 0,
                    onlineUsers: parseInt(document.getElementById('onlineUsers').textContent) || 0
                },
                source: 'bot_dashboard_export'
            };

            // –≠–∫—Å–ø–æ—Ä—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
            if (format === 'json') {
                exportAsJSON(exportData);
            } else if (format === 'csv') {
                exportAsCSV(exportData);
            } else if (format === 'excel') {
                exportAsExcel(exportData);
            }

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                buttons.forEach(btn => btn.disabled = false);
            }, 2000);
        }

        // ==================== JSON –≠–ö–°–ü–û–†–¢ ====================

        function exportAsJSON(data) {
            try {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON –∫—Ä–∞—Å–∏–≤–æ
                const jsonStr = JSON.stringify(data, null, 2);

                // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-stats-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // –û—á–∏—â–∞–µ–º URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                showMessage('‚úÖ JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ JSON: ${error.message}`, 'error');
            }
        }

        // ==================== CSV –≠–ö–°–ü–û–†–¢ ====================

        function exportAsCSV(data) {
            try {
                // –°–æ–∑–¥–∞–µ–º CSV –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                let csv = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞\n\n';
                csv += '–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞,' + new Date().toLocaleString() + '\n\n';
                csv += '–ü–û–ö–ê–ó–ê–¢–ï–õ–ò,–ó–ù–ê–ß–ï–ù–ò–ï\n';
                csv += '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,' + (data.dashboard.totalUsers || 0) + '\n';
                csv += '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,' + (data.dashboard.activeUsers || 0) + '\n';
                csv += '–°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è,' + (data.dashboard.messagesToday || 0) + '\n';
                csv += '–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å,' + (data.dashboard.onlineUsers || 0) + '\n\n';
                csv += '–≠–ö–°–ü–û–†–¢–ò–†–û–í–ê–ù–û –ò–ó,–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ VK –±–æ—Ç–∞\n';
                csv += '–ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–•,–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞\n';

                // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-stats-${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // –û—á–∏—â–∞–µ–º URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                showMessage('‚úÖ CSV —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ CSV: ${error.message}`, 'error');
            }
        }

        // ==================== EXCEL –≠–ö–°–ü–û–†–¢ ====================

        function exportAsExcel(data) {
            try {
                // –°–æ–∑–¥–∞–µ–º HTML —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä—É—é Excel —Å–º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="UTF-8">
                        <!--[if gte mso 9]>
                        <xml>
                            <x:ExcelWorkbook>
                                <x:ExcelWorksheets>
                                    <x:ExcelWorksheet>
                                        <x:Name>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</x:Name>
                                        <x:WorksheetOptions>
                                            <x:DisplayGridlines/>
                                        </x:WorksheetOptions>
                                    </x:ExcelWorksheet>
                                </x:ExcelWorksheets>
                            </x:ExcelWorkbook>
                        </xml>
                        <![endif]-->
                        <style>
                            table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                            th { background-color: #4CAF50; color: white; padding: 12px; text-align: left; font-weight: bold; }
                            td { border: 1px solid #ddd; padding: 10px; }
                            .title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px; }
                            .subtitle { font-size: 14px; color: #666; margin-bottom: 10px; }
                            .timestamp { color: #888; font-size: 12px; margin-top: 20px; }
                        </style>
                    </head>
                    <body>
                        <div class="title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ VK –ë–æ—Ç–∞</div>
                        <div class="subtitle">–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${new Date().toLocaleString()}</div>

                        <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                        <table>
                            <tr>
                                <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            </tr>
                            <tr>
                                <td>üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td>
                                <td>${data.dashboard.totalUsers || 0}</td>
                                <td>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</td>
                            </tr>
                            <tr>
                                <td>üü¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td>
                                <td>${data.dashboard.activeUsers || 0}</td>
                                <td>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø—Ä–æ—è–≤–∏–≤—à–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</td>
                            </tr>
                            <tr>
                                <td>üí¨ –°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</td>
                                <td>${data.dashboard.messagesToday || 0}</td>
                                <td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è</td>
                            </tr>
                            <tr>
                                <td>üü° –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</td>
                                <td>${data.dashboard.onlineUsers || 0}</td>
                                <td>–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</td>
                            </tr>
                        </table>

                        <h2>–ú–µ—Ç—Ä–∏–∫–∏</h2>
                        <table>
                            <tr>
                                <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                            </tr>
                            <tr>
                                <td>–ü—Ä–æ—Ü–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td>
                                <td>${data.dashboard.totalUsers > 0 ? ((data.dashboard.activeUsers / data.dashboard.totalUsers) * 100).toFixed(1) : 0}%</td>
                            </tr>
                            <tr>
                                <td>–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</td>
                                <td>${data.dashboard.totalUsers > 0 ? (data.dashboard.messagesToday / data.dashboard.totalUsers).toFixed(2) : 0}</td>
                            </tr>
                            <tr>
                                <td>–û–Ω–ª–∞–π–Ω –ø—Ä–æ—Ü–µ–Ω—Ç</td>
                                <td>${data.dashboard.totalUsers > 0 ? ((data.dashboard.onlineUsers / data.dashboard.totalUsers) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        </table>

                        <div class="timestamp">
                            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞–Ω–µ–ª—å—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ VK –±–æ—Ç–∞<br>
                            –î–∞—Ç–∞: ${new Date().toLocaleString()}<br>
                            –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
                        </div>
                    </body>
                    </html>
                `;

                // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob([html], {
                    type: 'application/vnd.ms-excel'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-stats-${new Date().toISOString().slice(0,10)}.xls`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // –û—á–∏—â–∞–µ–º URL
                setTimeout(() => URL.revokeObjectURL(url), 100);

                showMessage('‚úÖ Excel —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel: ${error.message}`, 'error');
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ====================

            function showMessage(text, type = 'info') {
        // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –í –ö–û–ù–°–û–õ–ò (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
        console.log(`${icon} ${text}`);

        // 2. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ù–ê –≠–ö–†–ê–ù–ï (–∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            min-width: 300px;
            font-weight: bold;
        `;

                     // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#17a2b8';
            }

            notification.textContent = text;
            document.body.appendChild(notification);

            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

    </script>


}
