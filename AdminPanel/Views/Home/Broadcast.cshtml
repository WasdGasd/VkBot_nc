
@{
    ViewData["Title"] = "–†–∞—Å—Å—ã–ª–∫–∞";
}

<h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>

<div class="card mt-4">
    <div class="card-body">
        <div class="mb-3">
            <label for="broadcastMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:</label>
            <textarea id="broadcastMessage" class="form-control" rows="6"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º..."></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</label>
            <div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipients" id="allUsers" value="all" checked>
                    <label class="form-check-label" for="allUsers">
                        üì® –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipients" id="activeUsers" value="active">
                    <label class="form-check-label" for="activeUsers">
                        üü¢ –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                    </label>
                </div>
            </div>
        </div>

        <!-- —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div id="statusMessage" class="alert d-none"></div>
        
        <button onclick="sendBroadcast()" class="btn btn-warning btn-lg">
            üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
        </button>
    </div>
</div>

@section Scripts {
    <script>
        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            if (!message) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            // —Å–º–æ—Ç—Ä–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            const recipientType = document.querySelector('input[name="recipients"]:checked').value;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) {
                return;
            }

            // —Å—Ç–∞—Ç—É—Å
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = 'alert alert-info';
            statusEl.innerHTML = 'üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...';
            statusEl.classList.remove('d-none');

            try {
                // –∏—Å–ø–æ–ª—å–∑. —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –∏–∑ ApiController
                const response = await fetch('/api/Api/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        recipientType: recipientType
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    statusEl.className = 'alert alert-success';
                    statusEl.innerHTML = '‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!';
                    document.getElementById('broadcastMessage').value = '';
                } else {
                    statusEl.className = 'alert alert-danger';
                    statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + result.message;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                statusEl.className = 'alert alert-danger';
                statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏: ' + error.message;
            }
        }
    </script>
}
