@{
    ViewData["Title"] = "–†–∞—Å—Å—ã–ª–∫–∞";
}

<h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>

<div class="card mt-4">
    <div class="card-body">
        <div class="mb-3">
            <label for="broadcastMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:</label>
            <textarea id="broadcastMessage" class="form-control" rows="6"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º..."></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</label>
            <div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipients" id="allUsers" value="all" checked>
                    <label class="form-check-label" for="allUsers">
                        üì® –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="recipients" id="activeUsers" value="active">
                    <label class="form-check-label" for="activeUsers">
                        üü¢ –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                    </label>
                </div>
            </div>
        </div>

        <!-- —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div id="statusMessage" class="alert d-none"></div>

        <!-- –ò–ó–ú–ï–ù–ò–õ: –¥–æ–±–∞–≤–∏–ª id –∏ —É–±—Ä–∞–ª onclick -->
        <button id="sendBroadcastBtn" class="btn btn-warning btn-lg">
            üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
        </button>
    </div>
</div>

@section Scripts {
    <script>
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', function() {
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ ID –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            const sendButton = document.getElementById('sendBroadcastBtn');
            if (sendButton) {
                sendButton.addEventListener('click', sendBroadcast);
            }
        });

        async function sendBroadcast() {
            console.log('–§—É–Ω–∫—Ü–∏—è sendBroadcast –≤—ã–∑–≤–∞–Ω–∞'); // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

            const message = document.getElementById('broadcastMessage').value;
            if (!message) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                return;
            }

            const recipientType = document.querySelector('input[name="recipients"]:checked').value;

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }

            const statusEl = document.getElementById('statusMessage');
            statusEl.className = 'alert alert-info';
            statusEl.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...';
            statusEl.classList.remove('d-none');

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/Broadcast');
                // –ò–°–ü–†–ê–í–ò–õ: –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/Broadcast –≤–º–µ—Å—Ç–æ /api/Api/broadcast
                const response = await fetch('/api/Broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        recipientType: recipientType
                    })
                });

                console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);
                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);

                if (result.success) {
                    statusEl.className = 'alert alert-success';
                    statusEl.innerHTML = `
                        ‚úÖ ${result.message}<br>
                        <small>–í—Å–µ–≥–æ: ${result.total || 0}, –£—Å–ø–µ—à–Ω–æ: ${result.successCount || 0}, –û—à–∏–±–æ–∫: ${result.failCount || 0}</small>
                    `;
                    document.getElementById('broadcastMessage').value = '';
                } else {
                    statusEl.className = 'alert alert-danger';
                    statusEl.innerHTML = `‚ùå ${result.message}`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                statusEl.className = 'alert alert-danger';
                statusEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`;
            }
        }

        function showMessage(text, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) alert.remove();
            }, 5000);
        }
    </script>
}